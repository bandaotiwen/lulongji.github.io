---
layout:     post
title:      Brief database locking
subtitle:   简述数据库锁
date:       2019-02-18
author:     lulongji
header-img: img/post-bg-hacker.jpg
catalog: true
tags:
    - mysql
    - lock
---


# 说明

做研发很多年，使用了各种类型的数据库，对于各种锁机制也只是浅表性的知道而已，花费一些时间总结一些，也弄清他们的实现原理和使用方式。

其实数据库锁的出现是为了处理并发的问题，因为数据库是多用户共享的资源，当多个用户同时对数据库并发操作时，会带来数据不一致的问题，所以，锁主要用于多用户环境下保证数据库完整性和一致性。

并发控制的主要采用的技术手段：乐观锁、悲观锁和时间戳。

# 锁分类

先看图：

![锁分类](https://raw.githubusercontent.com/lulongji/lulongji.github.io/master/imgs/mysql/sfl.png)


从程序的角度来看，锁主要分两类：

- 乐观锁
- 悲观锁

```乐观锁```
>什么是乐观锁，顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以，不会上锁。但是在更新的时候会判断一下在此期间别人有没有更新这个数据，可以使用版本号等机制。

乐观锁适用于多读的应用类型，这样可以提高吞吐量。

```悲观锁```
>顾名思义，很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人拿这个数据就会block（阻塞），直到它拿锁。

悲观锁按使用性质划分：

- 共享锁（Share Lock）
- 排他锁（Exclusive Lock）
- 更新锁 (Update Lock)

悲观锁按作用范围划分为：

- 行锁
- 表锁

### 共享锁（Share Lock）

共享锁又称为读锁，简称S锁，顾名思义，共享锁就是多个事务对于同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改。```相当于对于同一把门，它拥有多个钥匙一样。```

### 排他锁（Exclusive Lock）

排他锁又称为写锁，简称X锁，顾名思义，排他锁就是不能与其他所并存，如一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，但是获取排他锁的事务是可以对数据就行读取和修改。

不要错误以为排他锁锁住一行数据后，其他事务就不能读取和修改该行数据，其实不是这样的。```排他锁指的是一个事务在一行数据加上排他锁后，其他事务不能再在其上加其他的锁```

mysql InnoDB引擎默认的修改数据语句，```update,delete,insert```都会自动给涉及到的数据加上排他锁，select语句默认不会加任何锁类型，如果加排他锁可以使用```select ...for update```语句，加共享锁可以使用```select ... lock in share mode```语句。所以加过排他锁的数据行在其他事务中是不能修改数据的，也不能通过```for update```和```lock in share mode```锁的方式查询数据，但可以直接通过```select ...from...```查询数据，因为普通查询没有任何锁机制。


### 更新锁 (Update Lock) 

用来预定要对此页施加X锁，它允许其他事务读，但不允许再施加U锁或X锁；当被读取的页将要被更新时，则升级为X锁；U锁一直到事务结束时才能被释放。

### 行锁

行级锁是Mysql中锁定粒度最细的一种锁，表示只针对当前操作的行进行加锁。行级锁能大大减少数据库操作的冲突。其加锁粒度最小，但加锁的开销也最大。行级锁分为共享锁 和 排他锁。

比如：

    SELECT * from city where id = "1"  lock in share mode; 

由于对于city表中,id字段为主键，就也相当于索引。执行加锁时，会将id这个索引为1的记录加上锁，那么这个锁就是行锁。

### 表锁

表级锁是MySQL中锁定粒度最大的一种锁，表示对当前操作的整张表加锁，它实现简单，资源消耗较少，被大部分MySQL引擎支持。最常使用的MYISAM与INNODB都支持表级锁定。表级锁定分为表共享读锁（共享锁）与表独占写锁（排他锁）。

### 页级锁

页级锁是MySQL中锁定粒度介于行级锁和表级锁中间的一种锁。表级锁速度快，但冲突多，行级冲突少，但速度慢。所以取了折衷的页级，一次锁定相邻的一组记录。BDB支持页级锁

-----------------

```行锁、表锁、页级锁的特性可大致归纳如下：```

    1） 表级锁：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。
    2） 行级锁：开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。
    3） 页面锁：开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。
